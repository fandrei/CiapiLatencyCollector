<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="Package" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" >

  <PropertyGroup>
    <SolutionRoot>$(MSBuildProjectDirectory)\</SolutionRoot>
    <MSBuildCommunityTasksPath>$(MSBuildProjectDirectory)\tools\msbuild\MSBuildCommunityTasks\</MSBuildCommunityTasksPath>
  </PropertyGroup>
  <Import Project="$(MSBuildCommunityTasksPath)\MSBuild.Community.Tasks.Targets"/>

  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Release</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">Any CPU</Platform>
    <MajorVersion>1</MajorVersion>
    <MinorVersion>0</MinorVersion>
    <!-- This gets set by the build server -->
    <BuildVersion>0</BuildVersion>
    <FullVersion>$(MajorVersion).$(MinorVersion).$(BuildVersion)</FullVersion>

    <TargetDir>$(MSBuildProjectDirectory)\_bin\$(Configuration)\</TargetDir>
    <TargetDir Condition=" '$(OutDir)' != '' ">$(OutDir)\</TargetDir>

    <!-- This should get set by the build server -->
    <API_KEY>should_be_set_by_buildserver</API_KEY>
    <APPMETRICS_ACCESS_KEY>should_be_set_by_buildserver</APPMETRICS_ACCESS_KEY>
  </PropertyGroup>

  <Target Name="UpdateVersion" >
    <Message Text="Updating version to $(FullVersion)" />

    <!-- Remove read-only attribute -->
    <ItemGroup>
      <AllCodeFiles Include="$(SolutionRoot)\**\*.*" />
    </ItemGroup>
    <Attrib ReadOnly="false" Files="@(AllCodeFiles)" />

    <!-- Update assembly version number using build number -->
    <FileUpdate
        Files="$(MSBuildProjectDirectory)\LatencyCollectorCore\Properties\AssemblyInfo.cs"
        Regex="AssemblyVersion\(&quot;.*&quot;\)"
        ReplacementText="AssemblyVersion(&quot;$(FullVersion)&quot;)" />
    <FileUpdate
        Files="$(MSBuildProjectDirectory)\LatencyCollectorService\Properties\AssemblyInfo.cs"
        Regex="AssemblyVersion\(&quot;.*&quot;\)"
        ReplacementText="AssemblyVersion(&quot;$(FullVersion)&quot;)" />
    <FileUpdate
        Files="$(MSBuildProjectDirectory)\Setup\Variables.wxi"
        Regex="ProductVersion *= *&quot;.*?&quot;"
        ReplacementText="ProductVersion = &quot;$(FullVersion)&quot;" />

    <ItemGroup>
      <MonitorFiles Include="$(MSBuildProjectDirectory)\LatencyCollectorCore\Monitors\*.cs" />
    </ItemGroup>
    <FileUpdate
        Files="@(MonitorFiles)"
        Regex="{API_KEY}"
        ReplacementText="$(API_KEY)" />

    <ItemGroup>
      <AllFiles Include="$(MSBuildProjectDirectory)\LatencyCollectorCore\**\*.cs" />
    </ItemGroup>
    <FileUpdate
        Files="@(AllFiles)"
        Regex="{APPMETRICS_ACCESS_KEY}"
        ReplacementText="$(APPMETRICS_ACCESS_KEY)" />
    
  </Target>

  <Target Name="Build" DependsOnTargets="UpdateVersion" >

    <MSBuild Projects="$(MSBuildProjectDirectory)\CiapiLatencyCollector.sln" Targets="Rebuild"
      Properties="Configuration=$(Configuration)" />

    <!-- Store version number for auto update -->
    <WriteLinesToFile File="$(TargetDir)\version.txt" Lines="$(FullVersion)" Overwrite="true" />

    <!-- Create deployable ZIPs for inclusion in the config site-->
    <ItemGroup>
      <!-- All files from build -->
      <ZipFiles Include="$(TargetDir)\**\*.*"
          Exclude="$(TargetDir)\**\*.zip;$(TargetDir)\**\*.pdb;$(TargetDir)\**\*.xml;
            $(TargetDir)\**\*.vshost.exe;$(TargetDir)\**\*.vshost.exe.*;
            $(TargetDir)\**\CiapiLatencyCollector.*;$(TargetDir)\**\Ionic.Zip.dll" />
    </ItemGroup>
    <Zip Files="@(ZipFiles)"
      WorkingDirectory="$(TargetDir)"
      ZipFileName="$(TargetDir)\LatencyCollectorCore.zip"
      ZipLevel="9" />

    <Copy SourceFiles="$(TargetDir)\LatencyCollectorCore.zip" 
          DestinationFolder="$(MSBuildProjectDirectory)\LatencyCollectorConfigSite\CIAPILatencyCollector\updates\" />
    <Copy SourceFiles="$(TargetDir)\version.txt" 
          DestinationFolder="$(MSBuildProjectDirectory)\LatencyCollectorConfigSite\CIAPILatencyCollector\updates" />

    <Zip Files="$(MSBuildProjectDirectory)\_setup\CiapiLatencyCollector.msi" Flatten="true"
      WorkingDirectory="$(TargetDir)"
      ZipFileName="$(MSBuildProjectDirectory)\LatencyCollectorConfigSite\CIAPILatencyCollector\setup\CiapiLatencyCollector.msi.zip"
      ZipLevel="9" />

    <!-- Build config site -->
    <MSBuild Projects="$(MSBuildProjectDirectory)\LatencyCollectorConfigSite\LatencyCollectorConfigSite.csproj" Targets="Package"
      Properties="Configuration=$(Configuration)" />

  </Target>

  <Target Name="Package" DependsOnTargets="Build" >
    <Copy SourceFiles="$(TargetDir)\LatencyCollectorCore.zip" DestinationFolder="$(MSBuildProjectDirectory)\_UpdatePackage\" />
    <Copy SourceFiles="$(TargetDir)\version.txt" DestinationFolder="$(MSBuildProjectDirectory)\_UpdatePackage\" />
  </Target>

</Project>
